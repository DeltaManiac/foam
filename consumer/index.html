<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/foam/styles.2e98cd11f42589b7a982.css">.popover{position:relative;max-width:16rem;box-shadow:0 10px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05);padding:1rem;border:1px solid var(--separator);border-radius:.5rem;background-color:var(--references-bg);max-height:16rem;overflow:hidden}.popover.no-max-width{max-width:90vw}.popover.with-markdown{font-size:.875rem}.popover h1{margin:0;padding:0;font-size:1rem}.popover ul{padding-left:1rem}.popover .more-content-blind{height:4rem;position:absolute;background:transparent;background:linear-gradient(0,var(--references-bg),var(--references-bg-80) 50%,var(--references-bg-0));top:12rem;width:100%;left:0}.tippy-box[data-animation=shift-away][data-state=hidden]{opacity:0}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=top]{transform:translateY(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=bottom]{transform:translateY(-10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=left]{transform:translateX(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=right]{transform:translateX(-10px)}.reference{text-decoration:none}.reference:hover{color:var(--references-highlight)}.reference>div{padding-top:.5rem;padding-bottom:.5rem}.reference>div>p{margin:0;font-size:.875rem}.reference>div>ul{margin:0}.references-block{color:var(--references-text);padding:1rem;margin:1rem 0;border-radius:.5rem;background-color:var(--references-bg);transition:background-color .3s ease,color .3s ease}.references-block>div{margin-bottom:1rem}.references-block>hr{margin-left:auto;margin-right:auto;width:8rem}.references-block a{color:var(--references-text);transition:color .3s ease}.references-block>p:last-child{margin-bottom:0}.note-container{background:var(--note-bg);transition:background .3s ease}.note-container:first-child{border-left:none}.note-container .note-content,.note-container .obstructed-label{transition:opacity 75ms linear}.note-container .obstructed-label{display:block;color:var(--text);text-decoration:none;font-size:17px;line-height:40px;font-weight:500;-ms-writing-mode:tb-lr;writing-mode:vertical-lr;margin-top:36px;top:0;bottom:0;left:0;position:absolute;background-color:transparent;width:40px;overflow:hidden;opacity:0;transition:color .3s ease;pointer-events:none}.note-container.note-container-highlighted{background:var(--references-bg);transition:background .3s ease}.note-content img{max-width:100%}@media screen and (max-width:800px){.note-container{padding:16px;width:100%;overflow-y:auto}}@media screen and (min-width:801px){.note-container{transition:box-shadow .1s linear,opacity 75ms linear,transform .2s cubic-bezier(.19,1,.22,1);flex-shrink:0;width:625px;max-width:625px;top:0;position:-webkit-sticky;position:sticky;flex-grow:1;border-left:1px solid var(--separator);padding:0}.note-content{overflow-y:auto;height:100%;padding:32px}.note-container-overlay{box-shadow:0 0 15px 3px var(--shadow)}.note-container-obstructed .note-content{opacity:0}.note-container-obstructed .obstructed-label{opacity:1;pointer-events:all}}.dark-mode-toggle{cursor:pointer;transform:scale(.6)}.dark-mode-toggle input{display:none}.dark-mode-toggle input+div{border-radius:50%;width:36px;height:36px;position:relative;box-shadow:inset 16px -16px 0 0 #fff;transform:scale(1) rotate(-2deg);transition:box-shadow .5s ease 0s,transform .4s ease .1s}.dark-mode-toggle input+div:before{content:"";width:inherit;height:inherit;border-radius:inherit;position:absolute;left:0;top:0;transition:background .3s ease}.dark-mode-toggle input+div:after{content:"";width:8px;height:8px;border-radius:50%;margin:-4px 0 0 -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--link),0 23px 0 var(--link),23px 0 0 var(--link),-23px 0 0 var(--link),15px 15px 0 var(--link),-15px 15px 0 var(--link),15px -15px 0 var(--link),-15px -15px 0 var(--link);transform:scale(0);transition:all .3s ease}.dark-mode-toggle input:checked+div{box-shadow:inset 32px -32px 0 0 #fff;transform:scale(.5) rotate(0deg);transition:transform .3s ease .1s,box-shadow .2s ease 0s}.dark-mode-toggle input:checked+:before{background:var(--link);transition:background .3s ease .1s}.dark-mode-toggle input:checked+:after{transform:scale(1.5);transition:transform .5s ease .15s}.graph-button{border:0;background:none;cursor:pointer}.graph-button svg g{stroke:var(--link)}header{width:100%;min-height:57px;z-index:5;background-color:var(--note-bg);border-bottom:1px solid var(--separator);display:flex;justify-content:space-between;align-items:center;padding:10px 32px;flex-wrap:wrap;transition:background-color .3s ease}header>a{font-weight:700;color:var(--text);text-decoration:none;transition:color .3s ease}header .controls{display:flex}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body.light-mode{--main-bg:#fafafc;--note-bg:#fff;--text:#1a202c;--separator:#e2e8f0;--shadow:rgba(0,0,0,0.1);--link:#3182ce;--references-bg:#ebf4ff;--references-bg-80:rgba(235,244,255,0.8);--references-bg-0:rgba(235,244,255,0);--references-text:#718096;--references-highlight:#4a5568}body.dark-mode{--main-bg:#000;--note-bg:#0a0d11;--text:#fafafc;--separator:#252525;--shadow:hsla(0,0%,100%,0.1);--link:#3da1ff;--references-bg:#17181a;--references-bg-80:rgba(23,24,26,0.8);--references-bg-0:rgba(23,24,26,0);--references-text:#8c9fbb;--references-highlight:#b3cbf0}body{background-color:var(--main-bg);color:var(--text);margin:0;padding:0;height:100vh;transition:background-color .3s ease,color .3s ease}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,p,pre{margin:0}*,:after,:before{box-sizing:border-box}h1,h2,h3{font-weight:700}hr{margin-top:1rem;margin-bottom:1rem;border:solid var(--separator);border-width:1px 0 0;box-sizing:content-box;height:0;overflow:visible}a{color:var(--link);text-decoration:underline;transition:color .3s ease}a:hover{text-decoration:none}h1{font-size:1.875rem;margin-top:1rem}h1,p{margin-bottom:1rem}.layout{height:100vh;display:flex;flex-direction:column}.note-columns-scrolling-container{display:flex;overflow-x:auto;overflow-y:hidden;flex-grow:1}.note-columns-container{display:flex;flex-grow:1;transition:width .1s cubic-bezier(.19,1,.22,1)}@media screen and (max-width:800px){.note-columns-container{width:unset!important}}.overlay{z-index:98;position:fixed;top:0;right:0;bottom:0;left:0;display:flex;align-items:center;justify-content:center;height:100%;width:100%;background-color:var(--shadow);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.modal{z-index:99;position:fixed;border-radius:8px;background-color:var(--main-bg);box-shadow:-5px -5px 15px -3px var(--shadow),0 4px 6px -2px rgba(0,0,0,.05)}.modal-close,.modal-scale{position:absolute;top:0;right:0;padding:5px;border:0;background:none;color:var(--text);cursor:pointer}.modal-close svg,.modal-scale svg{width:20px;height:20px}.modal-close path,.modal-scale path{fill:currentColor}.modal-scale{right:30px}.modal-minimized .modal-close svg,.modal-minimized .modal-scale svg{width:15px;height:15px}.modal-minimized .modal-scale{right:25px}.modal-body{height:100%;width:100%}.modal-body .node,.modal-body .text{cursor:pointer}</style><meta name="generator" content="Gatsby 2.24.23"/><link as="script" rel="preload" href="/foam/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-85621b2033c86df92074.js"/><link as="script" rel="preload" href="/foam/styles-89fd2ae28bdf06750a71.js"/><link as="script" rel="preload" href="/foam/app-8a429951b5ef7c72de4e.js"/><link as="script" rel="preload" href="/foam/framework-8c8d363c63d1a9a80d21.js"/><link as="script" rel="preload" href="/foam/webpack-runtime-9b1e8130bb834cf1d827.js"/><link as="fetch" rel="preload" href="/foam/page-data/consumer/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foam/static/d/2098632890.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foam/static/d/426988268.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/foam/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout"><header><a href="/foam/"><h3>Foam</h3></a><div class="controls"><button title="Show Graph visualisation" aria-label="Show Graph visualisation" class="graph-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20"><g fill="none" stroke-width="2"><circle cx="11.733" cy="3.181" r="1.902"></circle><circle cx="16.864" cy="10.861" r="1.902"></circle><circle cx="7.47" cy="16.822" r="1.902"></circle><circle cx="3.046" cy="6.275" r="1.902"></circle><circle cx="9.372" cy="10.861" r="1.902"></circle><line x1="11.635" x2="14.655" y1="10.861" y2="10.861"></line><line x1="10" x2="10.895" y1="8.959" y2="5.573"></line><line x1="7.47" x2="4.5" y1="9.68" y2="7.5"></line><line x1="8.25" x2="8.809" y1="14.92" y2="13.088"></line></g></svg></button><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></header><div class="note-columns-scrolling-container"><div class="note-columns-container" style="width:1250px"><div class="note-container   " style="left:0;right:-585px"><div class="note-content"><h1 id="consumer" style="position:relative">Consumer</h1><ul><li><p>Subscribes to topics and receives message</p></li><li><p>Consumer Group -&gt; method of scaling consumption</p><ul><li>Membership triggered by a <code>JoinGroup</code> call</li><li>First member is the de-facto group leader</li><li>leader assigns partitions to consumers in the consumer group</li><li>Membership is maintained by sending <em>heartbeats</em> at intervals regularly to the <em>group coordinator</em></li><li>Sent during <code>poll</code> and <code>commit</code></li><li>missing heartbeats for a period will trigger rebalance as the consumer is thought to be dead</li></ul></li><li><p><em>Rebalance</em> moving partition ownership from one consumer to another</p><ul><li>high scalability and availability</li><li>creates a short unavailability window</li></ul></li></ul><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:561px">
      <a class="gatsby-resp-image-link" style="display:block" target="_blank" rel="noopener" href="/foam/static/904963a471d97607ad62651a9f807b77/3fca6/kafka_consumer.png">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:57.85714285714286%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABsklEQVQoz5WS+2/SYBSG9/ebmMVFnUYTrmMUWm6lhcKgwMAJKmxdhzELwhYHglzGuM0f4LESSNQsWt/kzTn5zjlPTk6+HTZarVbr2Or00c1r0tVLsudXGI0bJrM79I/v0cwy2kWFrFlhPp//NrfVzjZZbgq1Rgfx5BMhvYxYNImVzvnSa3NQEJEzbmTdiyPjZzi+tQc0Wl38Sga/IOA5DCLEdeqfL3GFX6F4H6EePsatuBlNJ/aAZ82vSOkSSS2FFE0QlbO0um0EzUsh+oxc7DkuxcVoYhNoNLvWcBExIuMLKUTFBI3rJgcJD6q4hxp6itvKbQNPLaCUKqIoccRYgqAvRt2oWUAneWkXPfQEZ9xhH2g22/jTbxG1Aj7rfsl4lqvTKuFjGTUbRNVFArkI43/dcFv4fn9PfzCgPxytPe19o2cYhJNhPMca3nwCJX/EbDb7O/Ch4lY39QskYZ9Aymmdw4VwJDEaj+1t+DNuvVwu12/dXpdkYJ936ksqygs8qo1v86fWwE1z53aAkPISCewSlfZ4LTsY3o3/D/hr83Q+o2R+IFd9Y/mEQq3MYrF4EPgDn+9wMMMANmUAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="kafka consumer" title="kafka consumer" src="/foam/static/904963a471d97607ad62651a9f807b77/410f3/kafka_consumer.png" srcSet="/foam/static/904963a471d97607ad62651a9f807b77/0d3e1/kafka_consumer.png 140w,/foam/static/904963a471d97607ad62651a9f807b77/6b1e2/kafka_consumer.png 281w,/foam/static/904963a471d97607ad62651a9f807b77/410f3/kafka_consumer.png 561w,/foam/static/904963a471d97607ad62651a9f807b77/99072/kafka_consumer.png 842w,/foam/static/904963a471d97607ad62651a9f807b77/3fca6/kafka_consumer.png 1112w" sizes="(max-width: 561px) 100vw, 561px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><h1 id="creating-a-consumer" style="position:relative">Creating a Consumer</h1><h2 id="in-rust" style="position:relative">In [<a title="Rust" href="/foam/rust">rust</a>]</h2><p>Crate : <a href="https://crates.io/crates/kafka">kafka</a></p><pre><code class="language-Rust">use kafka::consumer::{Consumer, FetchOffset, GroupOffsetStorage};
let mut consumer =
   Consumer::from_hosts(vec!(&quot;localhost:9092&quot;.to_owned()))
      .with_topic_partitions(&quot;my-topic&quot;.to_owned(), &amp;[0, 1])
      .with_fallback_offset(FetchOffset::Earliest)
      .with_group(&quot;my-group&quot;.to_owned())
      .with_offset_storage(GroupOffsetStorage::Kafka)
      .create()
      .unwrap();
loop {
  for ms in consumer.poll().unwrap().iter() {
    for m in ms.messages() {
      println!(&quot;{:?}&quot;, m);
    }
    consumer.consume_messageset(ms);
  }
  consumer.commit_consumed().unwrap();
}
</code></pre><p>Crate : <a href="https://crates.io/crates/rdkafka">rdkafka</a></p><pre><code class="language-Rust">async fn consume(brokers: &amp;str, group_id: &amp;str, topics: &amp;[&amp;str]) {
    let context = CustomContext;

    let consumer: LoggingConsumer = ClientConfig::new()
        .set(&quot;group.id&quot;, group_id)
        .set(&quot;bootstrap.servers&quot;, brokers)
        .set(&quot;enable.partition.eof&quot;, &quot;false&quot;)
        .set(&quot;session.timeout.ms&quot;, &quot;6000&quot;)
        .set(&quot;enable.auto.commit&quot;, &quot;true&quot;)
        //.set(&quot;statistics.interval.ms&quot;, &quot;30000&quot;)
        //.set(&quot;auto.offset.reset&quot;, &quot;smallest&quot;)
        .set_log_level(RDKafkaLogLevel::Debug)
        .create_with_context(context)
        .expect(&quot;Consumer creation failed&quot;);

    consumer
        .subscribe(&amp;topics.to_vec())
        .expect(&quot;Can&#x27;t subscribe to specified topics&quot;);

    // consumer.start() returns a stream. The stream can be used ot chain together expensive steps,
    // such as complex computations on a thread pool or asynchronous IO.
    let mut message_stream = consumer.start();

    while let Some(message) = message_stream.next().await {
        match message {
            Err(e) =&gt; warn!(&quot;Kafka error: {}&quot;, e),
            Ok(m) =&gt; {
                let payload = match m.payload_view::&lt;str&gt;() {
                    None =&gt; &quot;&quot;,
                    Some(Ok(s)) =&gt; s,
                    Some(Err(e)) =&gt; {
                        warn!(&quot;Error while deserializing message payload: {:?}&quot;, e);
                        &quot;&quot;
                    }
                };
                info!(&quot;key: &#x27;{:?}&#x27;, payload: &#x27;{}&#x27;, topic: {}, partition: {}, offset: {}, timestamp: {:?}&quot;,
                      m.key(), payload, m.topic(), m.partition(), m.offset(), m.timestamp());
                if let Some(headers) = m.headers() {
                    for i in 0..headers.count() {
                        let header = headers.get(i).unwrap();
                        info!(&quot;  Header {:#?}: {:?}&quot;, header.0, header.1);
                    }
                }
                consumer.commit_message(&amp;m, CommitMode::Async).unwrap();
            }
        };
    }
}
</code></pre><hr/><h2 id="in-golang" style="position:relative">In [<a title="Golang" href="/foam/golang">golang</a>]</h2><p>Package : <a href="https://github.com/confluentinc/confluent-kafka-go">Confluent Inc</a></p><pre><code class="language-golang">func main() {

    c, err := kafka.NewConsumer(&amp;kafka.ConfigMap{
        &quot;bootstrap.servers&quot;: &quot;localhost&quot;,
        &quot;group.id&quot;:          &quot;myGroup&quot;,
        &quot;auto.offset.reset&quot;: &quot;earliest&quot;,
    })

    if err != nil {
        panic(err)
    }

    c.SubscribeTopics([]string{&quot;myTopic&quot;, &quot;^aRegex.*[Tt]opic&quot;}, nil)

    for {
        msg, err := c.ReadMessage(-1)
        if err == nil {
            fmt.Printf(&quot;Message on %s: %s\n&quot;, msg.TopicPartition, string(msg.Value))
        } else {
            // The client will automatically try to recover from all errors.
            fmt.Printf(&quot;Consumer error: %v (%v)\n&quot;, err, msg)
        }
    }

    c.Close()
}
</code></pre><h2 id="package--segmentio" style="position:relative">Package : <a href="https://github.com/segmentio/kafka-go">SegmentIO</a></h2><pre><code class="language-golang">func consumer(){}
r := kafka.NewReader(kafka.ReaderConfig{
    Brokers:   []string{&quot;localhost:9092&quot;},
    Topic:     &quot;topic-A&quot;,
    Partition: 0,
    MinBytes:  10e3, // 10KB
    MaxBytes:  10e6, // 10MB
})
r.SetOffset(42)

for {
    m, err := r.ReadMessage(context.Background())
    if err != nil {
        break
    }
    fmt.Printf(&quot;message at offset %d: %s = %s\n&quot;, m.Offset, string(m.Key), string(m.Value))
}

r.Close()
}
</code></pre><p>Package : <a href="https://github.com/Shopify/sarama">Sarama</a></p><pre><code class="language-golang">// ConsumeClaim must start a consumer loop of ConsumerGroupClaim&#x27;s Messages().
func (consumer *Consumer) ConsumeClaim(session sarama.ConsumerGroupSession, claim sarama.ConsumerGroupClaim) error {

    // NOTE:
    // Do not move the code below to a goroutine.
    // The `ConsumeClaim` itself is called within a goroutine, see:
    // https://github.com/Shopify/sarama/blob/master/consumer_group.go#L27-L29
    for message := range claim.Messages() {
        log.Printf(&quot;Message claimed: value = %s, timestamp = %v, topic = %s&quot;, string(message.Value), message.Timestamp, message.Topic)
        session.MarkMessage(message, &quot;&quot;)
    }

    return nil
}

go func() comsumer{
        defer wg.Done()
        for {
            // `Consume` should be called inside an infinite loop, when a
            // server-side rebalance happens, the consumer session will need to be
            // recreated to get the new claims
            if err := client.Consume(ctx, strings.Split(topics, &quot;,&quot;), &amp;consumer); err != nil {
                log.Panicf(&quot;Error from consumer: %v&quot;, err)
            }
            // check if context was cancelled, signaling that the consumer should stop
            if ctx.Err() != nil {
                return
            }
            consumer.ready = make(chan bool)
        }
    }()

</code></pre><h1 id="commits" style="position:relative">Commits</h1><ul><li><p>Consumers use kafka to track their position in each partition</p></li><li><p><code>commit</code> act of updating current position in kafka</p></li><li><p>message <code>__consumer_offsets</code> topic with the offset for each partition</p></li><li><p>when rebalance each consumer receives a new partition and obtains the latest committed offset from where to start reading</p></li><li><p>Commit Strategy</p><ul><li><p>Automatic</p><ul><li>Done by consumer every 5 seconds configurable</li><li>Commits largest offset from <code>poll</code></li><li>call to <code>poll</code> will always commit the last offset</li><li>results in double processing if <code>rebalance</code> occurs in between a 5 sec window</li></ul></li><li><p>Commit Current Offset</p><ul><li>Gives control to the developer</li><li><code>commitSync</code> triggers commit of the last offset returned by <code>poll</code></li><li>must be called after processing all messages</li><li>Synchronous call blocks the application</li><li>Auto retry till success of non retry-able failure</li></ul></li><li><p>Asynchronous Commit</p><ul><li>Fire and forget till we get a callback</li><li>Does not auto retry as a later commit request might have latest Offset</li></ul></li><li><p>Async + Sync Commit</p><ul><li><code>CommitAsync</code> always</li><li>Trigger a CommitSync just before exit</li></ul></li></ul></li></ul><div class="references-block"><h3>Referred in</h3><div><div><a class="reference" href="/foam/kafka"><div><h5>Apache Kafka</h5></div></a></div><div><a class="reference" href="/foam/golang"><div><h5>Golang</h5></div></a></div><div><a class="reference" href="/foam/rust"><div><h5>Rust</h5></div></a></div></div></div></div><a aria-current="page" class="obstructed-label" href="/foam/consumer">Consumer</a></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/consumer";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-fd7ae9db326d5475b438.js"],"app":["/app-8a429951b5ef7c72de4e.js"],"component---node-modules-gatsby-theme-garden-src-templates-local-file-js":["/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-85621b2033c86df92074.js"]};/*]]>*/</script><script src="/foam/polyfill-fd7ae9db326d5475b438.js" nomodule=""></script><script src="/foam/webpack-runtime-9b1e8130bb834cf1d827.js" async=""></script><script src="/foam/framework-8c8d363c63d1a9a80d21.js" async=""></script><script src="/foam/app-8a429951b5ef7c72de4e.js" async=""></script><script src="/foam/styles-89fd2ae28bdf06750a71.js" async=""></script><script src="/foam/component---node-modules-gatsby-theme-garden-src-templates-local-file-js-85621b2033c86df92074.js" async=""></script></body></html>